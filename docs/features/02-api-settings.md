# API设置（API Settings）

## 功能概述
API设置模块用于管理大语言模型（LLM）服务的接口配置，包括自定义API端点、预定义服务商（如OpenAI、Gemini、Qwen等）、向量嵌入服务以及渠道管理。该模块位于 `api-settings/` 目录，是整个内容生产流程的基础设施层。

## 业务逻辑
1. **API配置存储**：
   - 通过 `ContentAuto_ApiConfig` 类管理配置的增删改查。
   - 配置项包括：API名称、端点URL、模型名称、API密钥、角色描述、向量模型等。
   - 支持自定义API和预定义API（从 `class-predefined-api.php` 读取常见服务商模板）。
2. **渠道管理**：
   - 实现官方渠道（`class-official-channel.php`）和第三方渠道（如 `class-pollinations-channel.php`）的抽象层。
   - 基类 `class-api-channel.php` 定义调用接口规范，子类实现具体请求逻辑。
3. **连接测试**：
   - 提供测试按钮，AJAX调用 `content_auto_manager_test_api_connection` 或 `content_auto_manager_test_predefined_api` 验证API可用性。
   - 测试时发送简单提示词，检查返回状态和响应内容。
4. **多配置管理**：
   - 支持同时维护多个API配置，每个规则可选择使用哪个API。
   - 启用/禁用开关允许快速切换配置，无需删除。

## 使用场景
- 初始化插件：配置第一个LLM API，如OpenAI GPT-4或国内Qwen服务。
- 多服务商策略：配置多个API，分别用于高质量文章生成和快速主题批量生成。
- 备用冗余：主API不可用时，规则自动切换到备用API。
- 成本优化：低成本API用于主题生成，高性能API用于正式文章内容生成。

## 实际业务应用

### 1. 新站冷启动配置
**业务场景**：刚安装插件的新网站，需要从零开始配置第一个AI服务，完成首批内容生产。

**操作流程**：
- 进入"API设置"页面，点击"添加自定义API"或选择"预定义API"
- 选择"OpenAI (通义千问)"作为服务商，系统自动填充端点URL和模型名称
- 输入从阿里云控制台获取的API Key
- 在"角色描述"中填写：`你是一位专业的科技评测编辑，擅长撰写深度产品分析文章`
- 点击"测试连接"，系统发送测试请求，返回成功响应
- 保存配置，在"规则管理"中创建第一条内容生成规则并选择该API

**实际案例**：某个人博客站长购买了通义千问API套餐（每月100万tokens），配置完成后创建主题规则，一天内自动生成了50个高质量文章标题，然后创建文章规则，一周产出200篇技术评测文章，网站从0到收录仅用15天。

### 2. 多API成本优化策略
**业务场景**：网站每日产出100篇文章，主题生成和文章生成分别使用不同模型以降低成本。

**操作流程**：
- 配置API #1："通义千问-快速版"（qwen-turbo），成本0.002元/千tokens
  - 用途：主题批量生成（每次生成50个标题）
  - 角色描述：简洁、快速生成文章标题
- 配置API #2："通义千问-智能版"（qwen-plus），成本0.008元/千tokens
  - 用途：正式文章生成（每篇1500-2000字）
  - 角色描述：详细、深度的文章内容创作
- 配置API #3："通义千问-旗舰版"（qwen-max），成本0.04元/千tokens
  - 用途：高价值核心内容（重点推广的深度长文）
  - 角色描述：顶级内容创作，注重专业性和SEO优化

**成本计算**：
- 主题生成：50个标题 × 200 tokens = 10,000 tokens → 0.02元
- 普通文章：80篇 × 2,000 tokens = 160,000 tokens → 1.28元
- 核心文章：20篇 × 5,000 tokens = 100,000 tokens → 4元
- 每日总成本：5.3元，月成本约160元

**对比单一高端API**：若全部使用qwen-max，月成本将达到800元，节省80%费用。

### 3. 容灾备份与负载均衡
**业务场景**：网站依赖内容自动化系统维持流量，需要确保API故障时不中断服务。

**操作流程**：
- 配置主API：OpenAI GPT-3.5（海外服务，速度快但可能受网络影响）
- 配置备用API #1：阿里云通义千问（国内服务，稳定性高）
- 配置备用API #2：百度文心一言（第三备份）
- 在"规则管理"中为不同时段配置不同API：
  - 工作日白天：使用OpenAI（响应快）
  - 晚间与周末：使用通义千问（成本低）
  - 紧急情况：手动切换到文心一言

**故障切换实战**：
- 某日凌晨OpenAI API出现全球性故障（503错误）
- 运营人员通过仪表盘发现任务队列停滞
- 进入"规则管理"，批量修改5条规则，将API从OpenAI切换到通义千问
- 10分钟内恢复任务处理，200条积压任务在2小时内消化完毕
- OpenAI服务恢复后，再次切换回主API

**实际案例**：某新闻网站配置了3个备用API，过去半年遭遇过2次主API限流、1次网络故障，通过快速切换备用API，实现了99.8%的服务可用性，0次内容断供。

### 4. 多语言国际化内容
**业务场景**：跨境电商网站需要同时生成中文、英文、日文三种语言的产品描述。

**操作流程**：
- 配置API #1：通义千问（中文版）
  - 角色描述：`专业电商文案编辑，擅长撰写吸引人的中文产品描述`
- 配置API #2：OpenAI GPT-4（英文版）
  - 角色描述：`Professional e-commerce copywriter, expert in creating compelling product descriptions`
- 配置API #3：Claude (Anthropic)（日文版）
  - 角色描述：`プロのEコマースコピーライター、魅力的な商品説明の作成に精通`
- 创建三套规则，分别对应三种语言，选择相应的API配置
- 同一产品ID通过变量注入，生成三种语言版本的描述

**效果对比**：
- 使用单一中文API强制生成英文/日文：准确率70%，语法错误多
- 使用原生语言API：准确率95%，符合当地表达习惯
- 转化率提升：英文市场提升35%，日文市场提升42%

**实际案例**：某跨境家居品牌使用该策略，为3000个SKU生成了三语言描述，人工审校时间从预计60天缩短到15天，产品上架速度提升4倍。

### 5. 行业专用模型配置
**业务场景**：医疗健康网站需要生成严谨的医学科普内容，要求引用权威资料并避免虚假宣传。

**操作流程**：
- 配置专用API：智谱AI GLM-4（针对中文优化，支持长文本）
- 设置详细的角色描述：
  ```
  你是一位持有医师执照的医学编辑，具有10年医学科普写作经验。
  你的职责是：
  1. 基于循证医学撰写准确的健康科普文章
  2. 引用权威医学期刊和卫生部门指南
  3. 避免夸大疗效、禁止推荐未经批准的治疗方法
  4. 使用通俗易懂的语言解释医学术语
  5. 在文章末尾注明：本文仅供参考，具体诊疗请咨询医生
  ```
- 配置向量模型：使用医疗领域专用嵌入模型（若API支持）
- 在发布规则中添加免责声明模板

**质量提升**：
- 普通API生成内容：20%出现专业性错误，15%包含不当建议
- 专用配置生成内容：错误率降低到5%，人工审校通过率从60%提升到85%
- 用户投诉率：从月均18次降低到3次
- 搜索引擎信任度：通过百度健康认证，排名提升明显

**实际案例**：某中医养生平台配置了垂直领域API后，生成的800篇养生文章中，有600篇被百度健康频道收录，带来月均10万UV流量增长。

### 6. 向量服务单独配置
**业务场景**：网站启用了向量聚类和智能分类功能，需要配置专门的向量嵌入API。

**操作流程**：
- 在API配置页面，为主要API勾选"向量模型"选项
- 填写向量模型名称：`text-embedding-v2`（OpenAI）或`bge-large-zh-v1.5`（通义）
- 测试向量生成：系统发送测试文本，返回1536维向量数据
- 保存后，所有新增主题和品牌资料将自动生成向量
- 在"向量聚类"页面验证向量生成状态

**性能对比**：
- 未配置向量API：主题无法自动分类，手工匹配工作量大
- 配置后：95%主题自动分配到正确分类，相似主题去重准确率92%

**实际案例**：某内容聚合平台导入了15万条历史标题，通过向量聚类自动归类到500个细分主题，原本需要10人月的分类工作在3天内完成。

## 技术实现
- 数据表：`{prefix}_content_auto_api_configs`，包含 `config_name`, `api_endpoint`, `model_name`, `api_key`, `role_description`, `vector_model` 等字段。
- 参数类：`class-api-config-params.php` 定义参数验证与封装。
- AJAX处理器：`shared/ajax-handlers.php` 中注册测试连接和配额查询接口。
- 表单页面：`api-settings/views/api-config-form.php` 渲染编辑界面。

## 相关文件
- `api-settings/class-api-config.php`（核心配置管理类）
- `api-settings/class-api-config-params.php`（参数验证）
- `api-settings/class-api-channel.php`（渠道抽象基类）
- `api-settings/class-official-channel.php`（官方API渠道实现）
- `api-settings/class-predefined-api.php`（预定义服务商模板）
- `api-settings/views/api-config-form.php`（界面渲染）
- `shared/ajax-handlers.php`（AJAX处理）
