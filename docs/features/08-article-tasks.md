# 文章任务（Article Tasks）

## 功能概述
文章任务模块用于将主题库中的主题转化为完整文章，实现从标题到正文内容的自动化生成。核心类 `ContentAuto_ArticleTaskManager` 位于 `article-tasks/class-article-task-manager.php`，通过任务队列逐篇生成文章内容。

## 业务逻辑
1. **任务创建**：
   - `create_article_task($topic_ids, $name)` 接收主题ID数组，创建文章生成任务。
   - 验证主题存在性，生成唯一 `article_task_id`，插入 `content_auto_article_tasks` 表。
   - 使用 `topic_ids` 字段（JSON数组）记录需要处理的所有主题。
2. **任务调度**：
   - 任务添加到 `content_auto_job_queue` 表，由 `ContentAuto_JobQueue` 调度执行。
   - 每次处理一个主题，生成完成后更新进度统计（`completed_topics`, `failed_topics`）。
3. **文章生成流程**：
   - 调用 `ContentAuto_ArticleGenerator` 根据主题标题、规则配置、发布规则生成正文内容。
   - 使用 `ContentAuto_ArticleApiHandler` 与AI API交互，获取文章内容。
   - 解析模型返回的内容，处理 HTML/Markdown 格式，提取特色图片描述。
4. **文章发布**：
   - 根据发布规则（`content_auto_publish_rules`）将文章插入WordPress文章表（`wp_posts`）。
   - 设置文章标题、内容、分类、标签、作者、发布状态（草稿/发布）等。
   - 如启用自动配图，调用图像API生成特色图片并附加到文章。
5. **状态管理与恢复**：
   - `ContentAuto_TaskStatusManager` 维护任务状态、记录错误信息。
   - `ContentAuto_ArticleTaskTimeoutHandler` 定时检测超时任务并自动恢复。
   - `class-article-queue-processor.php` 负责队列调度逻辑与子任务管理。
6. **性能监控**：
   - `ContentAuto_ArticlePerformanceMonitor` 记录每个环节的耗时、成功率、错误类型。

## 使用场景
- 批量文章生成：选中一批主题，一键生成完整文章。
- 自动化发布流水线：从主题生成到文章发布全流程自动化。
- 草稿预览：生成文章后先保存为草稿，人工审核后发布。
- 异常恢复：API超时或失败时，自动重试直到成功。

## 实际业务应用

### 1. 电商产品详情页批量生成
**业务场景**：跨境电商平台新上架500个SKU，需要快速生成产品详情页内容。

**操作流程**：
- **准备阶段**：
  - 导入500个产品名称作为主题（通过CSV批量导入或API对接）
  - 创建产品详情文章结构模板：产品概述 → 核心特点 → 使用场景 → 规格参数 → 购买建议
  - 配置品牌资料：品牌故事、品质承诺、售后服务等
  
- **生成配置**：
  - 创建文章任务：选择全部500个产品主题
  - 任务名称：`2024春季新品详情页`
  - 选择规则：`产品详情-标准模板`
  - API配置：`GPT-4`（高质量，适合产品页SEO）
  - 发布设置：先保存为草稿，待审核
  
- **执行监控**：
  - 系统按每分钟3篇的速度处理（避免API限流）
  - 预计完成时间：500篇 ÷ 3篇/分钟 = 167分钟（约2.8小时）
  - 实时查看任务进度：已完成235/500，失败3篇（网络超时，自动重试中）
  - 查看生成样例，发现"规格参数"部分不够详细，暂停任务
  - 优化提示词模板，添加`请详细列出尺寸、重量、材质、颜色选项等参数`
  - 恢复任务，继续处理剩余265篇

- **质量审核**：
  - 人工审核模式：抽检20%（100篇），重点检查参数准确性
  - 发现问题：8篇文章中的价格信息错误（AI编造数据）
  - 解决方案：在提示词中添加`禁止生成价格信息，价格由系统自动填充`
  - 批量修正后，通过审核的480篇直接发布，20篇问题文章重新生成

**效果评估**：
- 生成时间：3小时（传统人工需要50人天）
- 质量满意度：85%（人工审核通过率）
- SEO效果：30天后，有320个产品页在百度排名进入前3页
- 转化率提升：详细的产品描述使购物车加购率提升28%
- 成本节省：人工成本10万元 → AI成本500元 + 人工审核成本5000元

**实际案例**：某家居用品电商在备战双11时，使用该功能在1周内完成了2000个新品的详情页内容，比竞品提前2周上线，抢占了搜索引擎入口，大促期间该批新品贡献了35%的整体销售额。

### 2. 新闻媒体日常内容流水线
**业务场景**：科技新闻网站需要每天稳定产出30篇文章，覆盖行业动态、产品评测、深度分析等多种类型。

**自动化工作流**：
```
凌晨2:00 → 主题任务自动执行，生成50个新闻标题
凌晨3:00 → 编辑通过手机审核主题，删除不合适的15个，保留35个
上午8:00 → 文章任务自动触发，开始生成35篇文章
上午11:00 → 文章生成完成，编辑开始审核
下午2:00 → 审核完成，30篇文章定时发布（每20分钟发布1篇）
下午6:00 → 当日文章全部发布完毕，系统生成第二天主题
```

**任务配置详情**：
- **每日主题任务**：
  - 规则：`科技新闻-日常更新`
  - 分类：AI、芯片、新能源汽车、消费电子、互联网
  - 每分类生成10个主题
  - Cron调度：每天凌晨2:00执行

- **文章生成任务**：
  - 自动触发条件：主题审核完成 + 时间到达8:00
  - 生成策略：800-1200字快讯，自动配图
  - 发布策略：定时发布，每20分钟一篇（保持网站活跃度）
  - 特殊处理：重大新闻标记为"特快"，优先生成并立即发布

**异常处理机制**：
- **API故障**：自动切换到备用API，发送钉钉/企微告警通知
- **主题不足**：若凌晨主题生成失败，使用备用主题库（预存100个常青主题）
- **审核超时**：若上午10点前编辑未审核，系统自动选择评分最高的30个主题生成文章
- **内容重复**：通过向量相似度检测，自动过滤与历史文章相似度>85%的内容

**运营效果**：
- 内容产出：从日均18篇提升到30篇，产能提升67%
- 编辑效率：编辑从"创作"转为"审核+优化"，工作量减少50%
- 时效性：从热点爆发到发布文章平均时间从4小时缩短到1.5小时
- 流量增长：文章数量增加带动日UV从8万增长到12万
- 成本结构：新增2名编辑的成本抵消了3名资深编辑的工资

**实际案例**：某科技媒体实施该流水线后，编辑团队从12人精简到7人，但文章产出翻倍。在"苹果秋季发布会"等重大事件中，系统在发布会结束后30分钟内就发布了5篇不同角度的分析文章，流量激增，单日广告收入创历史新高。

### 3. SEO内容农场批量作业
**业务场景**：垂直领域网站需要快速覆盖大量长尾关键词，建立内容护城河。

**批量生产计划**：
- **第1批次（第1-2周）**：
  - 主题数量：2000个基础长尾词
  - 文章规格：800-1000字，标准结构
  - 生成速度：每天150篇
  - 发布策略：立即发布，占位SEO
  
- **第2批次（第3-6周）**：
  - 主题数量：5000个细分长尾词
  - 文章规格：1200-1500字，增加案例和图片
  - 生成速度：每天200篇
  - 发布策略：50%立即发布，50%定时发布（模拟人工更新频率）

- **第3批次（第7周开始）**：
  - 主题数量：根据第1-2批次收录情况和排名数据，精选高价值词
  - 文章规格：2000-3000字深度内容
  - 生成速度：每天50篇精品
  - 发布策略：全部立即发布，重点优化

**任务执行细节**：
- 使用"文章任务列表"页面批量创建任务，每次500个主题一组
- 设置任务优先级：精品内容 > 细分词 > 基础词
- 夜间执行大批量任务（降低白天服务器负载）
- 监控每日API token消耗，确保不超预算

**风险控制**：
- **内容质量**：每天人工抽查50篇，质量不达标的主题加入黑名单
- **重复检测**：启用向量聚类，自动过滤相似主题
- **搜索引擎惩罚**：控制发布节奏，避免短期暴增被判定为spam
- **法律风险**：敏感行业（医疗、金融）强制人工审核，不能自动发布

**实际数据**：
- 3个月产出：15000篇文章
- 收录情况：60天后收录率达到72%（10800篇）
- 排名表现：8500个长尾词进入百度前10页，1200个词进入前3页
- 流量效果：自然搜索流量从日均5000 UV增长到68000 UV
- 收入效果：广告收入从月均8000元增长到12万元

**实际案例**：某本地生活服务平台使用该策略，针对全国300个城市 × 50个服务类型，生成了15000篇"城市+服务"组合文章，成为百度本地服务类搜索的重要流量入口，6个月后被行业巨头以千万级价格收购。

### 4. 内容更新与再创作
**业务场景**：网站有3000篇老文章，内容过时且排名下降，需要批量更新优化。

**操作流程**：
- **筛选需要更新的文章**：
  - 标准1：发布时间超过2年
  - 标准2：近90天PV低于100
  - 标准3：曾经排名前3，现在跌出前30
  - 筛选结果：800篇文章需要更新

- **生成更新内容主题**：
  - 提取800篇文章的标题作为主题
  - 主题状态标记为"更新"（is_used=2），区别于新创作
  - 在提示词中加入指令：`这是一篇更新文章，需要补充最新的行业动态、产品信息和数据`

- **批量创建更新任务**：
  - 任务名称：`2024Q1老文章更新批次`
  - 选择主题：800个更新主题
  - 生成策略：保留原文章结构，重写内容+增加新章节
  - 发布策略：覆盖原文章（使用相同post_id），保留URL不变

- **执行与监控**：
  - 分10批次执行，每批80篇
  - 每批完成后，人工抽查10%
  - 对比更新前后的关键词密度、字数、可读性
  - 重点检查是否保留了原文的核心信息

**SEO优化效果**：
| 指标 | 更新前 | 更新后30天 | 更新后90天 | 提升幅度 |
|------|--------|-----------|-----------|---------|
| 平均排名 | 28位 | 19位 | 14位 | 提升14位 |
| 收录比例 | 65% | 78% | 88% | +23% |
| 日均UV | 2500 | 4200 | 6800 | +172% |
| 跳出率 | 68% | 58% | 52% | -16% |
| 停留时间 | 1分20秒 | 2分10秒 | 2分45秒 | +106% |

**实际案例**：某技术博客有5000篇历史文章，其中2000篇内容涉及已过时的技术版本（如Python 2.x、Angular 1.x）。通过批量更新任务，将所有代码示例和技术说明更新到最新版本，整体流量恢复到历史最高水平，甚至超过20%。

### 5. 多语言内容同步生成
**业务场景**：跨国SaaS公司需要将产品文档、帮助中心文章同步生成为英文、中文、日文、西班牙文四种语言。

**工作流设计**：
- **主语言内容生成**（英文）：
  - 创建100个主题（产品功能说明）
  - 使用GPT-4生成1500-2000字的详细文档
  - 人工审核，确保专业术语准确
  - 审核通过后，触发多语言翻译任务

- **多语言翻译生成**：
  - 系统自动创建3个翻译任务（中文、日文、西班牙文）
  - 每个语言任务包含100篇文章
  - 提示词模板：`将以下英文技术文档翻译为{目标语言}，保持专业术语准确，符合当地表达习惯`
  - 注入原英文文章内容作为参考
  - 生成后保存为对应语言的文章

- **内容关联管理**：
  - 在postmeta中记录文章的语言版本关系
  - 用户访问时根据浏览器语言自动切换
  - 四种语言版本的URL结构：
    - 英文：`/docs/feature-a`
    - 中文：`/zh/docs/feature-a`
    - 日文：`/ja/docs/feature-a`
    - 西班牙文：`/es/docs/feature-a`

**质量控制**：
- 机器翻译质量评分：通过BLEU算法对比专业翻译样本，评分低于0.6的重新生成
- 人工校对：每种语言安排1名母语编辑审核
- 术语库维护：建立200个核心专业术语的多语言对照表，强制使用统一翻译

**运营效果**：
- 4种语言 × 100篇文档 = 400篇内容，3天完成（传统翻译需要45天）
- 成本对比：AI翻译5000元 vs 人工翻译20万元，节省97.5%
- 质量评估：客户满意度调查，4种语言平均评分4.2/5.0（人工翻译历史平均4.5/5.0）
- 市场效果：日本市场产品注册量提升180%，西班牙语市场提升120%

**实际案例**：某国际化项目管理工具通过该策略，在进入新市场前就准备好了完整的本地化帮助文档，产品上线首日就有完整的多语言支持，用户体验得分超过本土竞品，3个月内在日本市场获得5000付费用户。

### 6. 定时发布与内容日历管理
**业务场景**：内容营销团队提前1个月规划内容日历，需要批量生成并定时发布。

**内容日历规划**：
```
第1周（科技周）：
- 周一：AI行业动态 × 2篇
- 周二：芯片技术解析 × 2篇
- 周三：开源项目推荐 × 2篇
- 周四：技术教程 × 2篇
- 周五：行业评论 × 2篇

第2周（产品周）：
- 周一~周五：产品评测 × 10篇

第3周（教程周）：
- 周一~周五：实战教程 × 10篇

第4周（总结周）：
- 周一~周四：周度总结 × 8篇
- 周五：月度总结 × 2篇
```

**批量任务配置**：
- 提前创建4周的主题（共50个）
- 批量创建文章任务，一次性生成50篇文章
- 设置每篇文章的发布时间：
  - 第1周文章：发布时间设置为1-5工作日，每天上午10:00
  - 第2周文章：发布时间设置为8-12工作日，每天上午10:00
  - 依此类推

**执行策略**：
- 在月初第1-2天集中生成所有文章（趁API配额充足）
- 生成后全部保存为"定时发布"状态
- WordPress定时任务每天10:00检查并发布当天的文章
- 编辑团队在发布前1天进行最后审核和微调

**优势总结**：
- **工作节奏平稳**：避免每天赶稿的压力，集中时间创作
- **内容质量**：有充足时间审核和优化，质量更稳定
- **应急响应**：遇到突发热点，可以临时插入热点文章
- **团队管理**：内容规划透明化，团队协作更高效
- **假期无忧**：节假日期间无需加班，文章自动发布

**实际案例**：某个人博主使用该功能，在春节前批量生成了30篇文章，设置为春节期间每天自动发布。假期期间完全不用管理网站，回来后发现流量不降反升，还新增了200个邮件订阅用户。

## 技术实现
- 数据表：
  - `content_auto_article_tasks`（任务）
  - `content_auto_articles`（生成的文章内容）
  - `wp_posts`（WordPress文章表）
- 核心类：
  - `ContentAuto_ArticleTaskManager`（任务管理）
  - `ContentAuto_ArticleGenerator`（文章生成逻辑）
  - `ContentAuto_ArticleApiHandler`（API通信）
  - `ContentAuto_ArticleQueueProcessor`（队列处理器）
  - `ContentAuto_ArticleTaskTimeoutHandler`（超时恢复）
  - `ContentAuto_ArticlePerformanceMonitor`（性能监控）
- 队列调度：通过 `shared/queue/class-job-queue.php` 调度执行。
- 前端页面：`article-tasks/views/article-tasks-list.php` 展示任务列表与详情。

## 相关文件
- `article-tasks/class-article-task-manager.php`
- `article-tasks/class-article-generator.php`
- `article-tasks/class-article-api-handler.php`
- `article-tasks/class-article-queue-processor.php`
- `article-tasks/class-article-task-timeout-handler.php`
- `article-tasks/class-article-performance-monitor.php`
- `article-tasks/views/article-tasks-list.php`
- `shared/queue/class-job-queue.php`
- `publish-settings/class-publish-settings-admin.php`（发布规则）
